# Developer Guide

The repository contains two main components:

- **dev:** the development code with a concrete (register) implementation for
  testing. The folder also contains templates for dynamic code and all the
  static code that will be bundled together with the generated code.
- **-plugins/gorums:** second order plugin to ```protoc-gen-gorums```
  binary.

### Makefile

Below is a description of the current Makefile targets.
The Makefile itself also serves as documentation; inspect it for details.

| Target | Description |
|--------|-------------|
| `all` | Run the `build` and `test` targets. |
| `build` | Build all packages in the repository. |
| `test` | Run all tests in the repository. |
| `testrace` | Run all tests in the repository with the race detector enabled. |
| `stresstestdev` | Run development test in a loop to catch sporadic failures. |
| `benchlocal` | Run a set of benchmarks with servers running as part of the test binary. |
| `benchremote` | Run a set of benchmarks that require separate running servers. See the benchmarks for details. |
| `clean` | Run `go clean` for the whole repository and remove all `.test` and `.prof` files. |
| `reinstallprotoc` | Install the `protoc-gen-gorums` binary with the gorums plugin included. |
| `devproto` | Compile the development register.proto file in the `dev` folder. |
| `gorumsprotoopts` | Compile the gorums protobuf options from the `gorums.proto` file. |
| `static` | Bundle the static (generic) code used by the gorums plugin. |
| `templates` | Generate the templates code bundle used by the gorums plugin. |
| `golden` | Generate and update the golden `protoc-gen-gorums` compiler output used by a test. |
| `dev` | Generate _gen.go files for the `dev` folder. |
| `goldenanddev` | Run both the`golden` and `dev` target. |
| `prof{cpu,mem,obj}` | Create a CPU/memory profile using a predefined benchmark. |
| `getdep` | Download the 'dep' vendoring tool. |
| `getchecktools{u}` | Download/update the static analysis tools. |
| `check` | Run a suite of static analysis tools. |
| `updatedeps` | Update vendored dependencies to the latest version available. |

#### File Endings

The following file ending conventions are used in the ```dev``` package:

* ```_gen.go```: File should be generated by the gorums plugin.
* ```_udef.go``` File is user defined.
* ```_test.go``` File is a Go test file.

These endings are important because all other files will be bundled together as
static resources during gorums code generation (see the
[bundle](https://github.com/relab/gorums/tree/master/cmd/bundle)) utility
program.

#### Workflow

1. Changes should be made to the development code in ```dev```.

2. Changes in any of the files ending with ```_gen.go``` **must** be reflected
   in the generator.

3. If the change is in a "static" file it's enough to update the bundle of
   static code. This can be done by calling ```make genstatic```. 

4. If any change is done to the static or generated code, the file representing
   the "golden" output of the generator must be regenerated. This can be done
   by running ```make gengolden```. 

See the Makefile for more details.

#### Testing

All tests can be invoked by running ```make test``` and/or ```make testrace```.
There are three main tests for this project:

1. **dev/config_rpc_test.go**: The integration test in this package
   verifies that the concrete client/server register implementation works.

2. **End-to-end**: This test invokes the generator with the ```register.proto```
   example from ```dev``` and runs the integration test against the
   *generated* code.

3. **Golden**: This test invokes the generator with the ```register.proto```
   example from ```dev``` and compares the output against a golden output
   file in the ```testdata``` folder. This test verifies that the generator
   output does not change unexpectedly.  The golden output file should be
   updated as described in the previous Workflow section if the output *is*
   expected to change.

### Benchmarking

The ```benchcmp``` program is recommended for comparing benchmarks:

```
go get -u  golang.org/x/tools/cmd/benchcmp
```

Example :

```shell
git checkout devel (or another branch)
cd dev
go test . -run=$$ -bench=Read1KQ2N3Local -benchtime=3s -count=10 > old.txt
*make changes and regenerate _gen.go-files if needed*
go test . -run=$$ -bench=Read1KQ2N3Local -benchtime=3s -count=10 > new.txt
benchcmp old.txt new.txt
```
